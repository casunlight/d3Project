
<!DOCTYPE html>
<html>
  <head>
    <meta http-equiv="Content-Type" content="text/html;charset=utf-8"/>
    <script src="http://d3js.org/d3.v3.min.js"></script>
    <script type="text/javascript" src="d3.geo.js"></script>
    <script type="text/javascript" src="http://code.jquery.com/jquery-1.10.2.min.js"></script>
	
    <link type="text/css" rel="stylesheet" href="style.css"/>
    <link type="text/css" rel="stylesheet" href="colorbrewer.css"/>
    <style type="text/css">
* {font-family: "Microsoft YaHei" ! important; } 

circle {
  fill: #fff;
}

path {
  fill: #1B6B62;
  stroke: #fff;
}
.background {
  fill: none;
  pointer-events: all;
}
.active {
-moz-transition: all 0.5s ease-in;
    -webkit-transition: all 0.5s ease-in;
    -o-transition: all 0.5s ease-in;
    transition: all 0.5s ease-in;
  fill: rgb(6, 194, 186);
}
.active:hover{
-moz-transition: all 0.2s ease-in;
    -webkit-transition: all 0.2s ease-in;
    -o-transition: all 0.5s ease-in;
    transition: all 0.2s ease-in;
fill:rgb(243, 221, 57)
}
#resultBox{
fill: #A8D8DF;
stroke: #97B6A7;
stroke-width: 12px;
stroke-opacity: 0.5;
}
    </style>
  </head>
  <body>
    <script type="text/javascript">
var centered,
width = 960,
height = 500;

var feature, info;

var projection = d3.geo.mercator()
	.scale(680)
	.translate([400, 300]);

var path = d3.geo.path()
	.projection(projection);

var svg = d3.select("body").append("svg").attr("width", width)
	.attr("height", height)
	.append("g")

	
		var ButtonGradient = svg.append("defs")
	.append("linearGradient")
	.attr("id", "ButtonGradient")
	.attr("x1", "0%")
	.attr("y1", "0%")
	.attr("x2", "100%")
	.attr("y2", "100%")
	.attr("spreadMethod", "pad");

ButtonGradient.append("stop")
.attr("offset", "0%")
.attr("stop-color", "#CFE7FA")
.attr("stop-opacity", 1);

ButtonGradient.append("stop")
.attr("offset", "100%")
.attr("stop-color", "#6393c1")
.attr("stop-opacity", 1);
	
	
			var blackGradient = svg.append("defs")
	.append("linearGradient")
	.attr("id", "blackGradient")
	.attr("x1", "0%")
	.attr("y1", "0%")
	.attr("x2", "100%")
	.attr("y2", "100%")
	.attr("spreadMethod", "pad");

blackGradient.append("stop")
.attr("offset", "0%")
.attr("stop-color", "#7d7e7d")
.attr("stop-opacity", 1);

blackGradient.append("stop")
.attr("offset", "100%")
.attr("stop-color", "#0e0e0e")
.attr("stop-opacity", 1);
	
	
	
	
	
	
	var gradient = svg.append("defs")
	.append("linearGradient")
	.attr("id", "gradient")
	.attr("x1", "0%")
	.attr("y1", "0%")
	.attr("x2", "100%")
	.attr("y2", "100%")
	.attr("spreadMethod", "pad");

gradient.append("stop")
.attr("offset", "0%")
.attr("stop-color", "#A1DBFF")
.attr("stop-opacity", 1);

gradient.append("stop")
.attr("offset", "50%")
.attr("stop-color", "#fff")
.attr("stop-opacity", 1);

gradient.append("stop")
.attr("offset", "100%")
.attr("stop-color", "#A1DBFF")
.attr("stop-opacity", 1);

var bg = svg.append("rect")
	.attr("class", "background")
	.attr("width", width)
	.attr("height", height).attr('stroke', 'black').style("fill", "url(#gradient)");

//zoom模块
var zoom = d3.behavior.zoom()
	.translate(projection.translate())
	.scale(projection.scale())
	.scaleExtent([height, 8 * height])
	.on("zoom", zoomed);

//call.zoom加载zoom模块
var g = svg.append("g").call(zoom).attr("width", width)
	.attr("height", height - 140);

var points = [projection([90, 35]), projection([140, -25]), projection([48, 55]), projection([20, 14]), projection([-99, 38]), projection([-62, -9])]//利用projection加工点


function zoomed() {
	projection.translate(d3.event.translate).scale(d3.event.scale); //改变projection
	g.selectAll("path").attr("d", path);
	var points = [projection([113, 35]), projection([115, 20]), projection([45, 65])]//重新对点赋值
	g.selectAll('circle')
	.attr('cx', function (d, i) {
		return points[i][0]
	})
	.attr('cy', function (d, i) {
		return points[i][1]
	})
	.attr('r', 3);
}

function createWorldMap(collection) {
	feature = g.append("g")
		.attr("id", "worldMap").selectAll("path")
		.data(collection.features)
		.enter().append("path")
		.attr("d", path).attr("transform", "translate(0," + 30 + ")").attr('opacity', 0).transition()
			.duration(250).attr('opacity', 1);

	g.append('g').attr('id', 'points').attr("transform", "translate(0," + 30 + ")").selectAll('circle').data(points).enter().append('circle')
	.attr('cx', function (d, i) {
		return points[i][0]
	})
	.attr('cy', function (d, i) {
		return points[i][1]
	})
	.attr('r', 3)

	feature.append("title")
	.text(function (d) {
		return d.properties.name;
	});
}

d3.json("world-countries.json", function (collection) {
	createWorldMap(collection)
});

var circleTimer = setInterval(function () {
		g.selectAll('circle').attr("r", 3).attr('opacity', 1).transition()
		.duration(750)
		.attr("r", 15).attr('opacity', 0)
	}, 750)

	//总标题
	var title = svg.append("g").attr("transform", "translate(100," + -50 + ")");

title.append('rect').attr('height', 20).attr('width', 250).attr("x", 40).attr('height', 30)
.attr("y", height).style("fill", "url(#blackGradient)");

title.append('rect').attr('height', 20).attr('width', 250).attr("x", 300).attr('height', 30)
.attr("y", height).style("fill", "url(#blackGradient)");

title.append('text').style('fill', 'white').style('font-size', '18px')
.attr("x", 200)
.attr("y", height + 15)
.attr("dy", ".35em")
.style("text-anchor", "end").text('中遠集團').on('click', changeToWorldMap)

title.append('text').style('fill', 'white').attr("x", 524).style('font-size', '18px')
.attr("y", height + 15)
.attr("dy", ".35em")
.style("text-anchor", "end").text('中遠(香港)集團有限公司').on('click', changeToChinaMap)





function changeToWorldMap() {
	g.transition()
	.duration(750)
	.attr("transform", "scale(1)");
	svg.selectAll('#legend').remove();
	svg.selectAll('#result').remove();
	svg.selectAll('#chinaMap').attr('opacity', 1).transition()
			.duration(550).attr('opacity', 0).remove();

	projection = d3.geo.mercator()
		.scale(680)
		.translate([400, 300]);

	path = d3.geo.path()
		.projection(projection);

	d3.json("world-countries.json", function (collection) {
		createWorldMap(collection);
	});
	circleTimer = setInterval(function () {
			g.selectAll('circle').attr("r", 3).attr('opacity', 1).transition()
			.duration(750)
			.attr("r", 15).attr('opacity', 0)
		}, 750)

}

function changeToChinaMap() {
	clearInterval(circleTimer)
	g.attr("transform", "scale(1)");
	svg.selectAll('#worldMap').attr('opacity', 1).transition()
			.duration(750).attr("transform", "scale(5)translate(-500," + -200 + ")").attr('opacity', 0).remove()
	svg.selectAll('#points').remove();
		svg.selectAll('#legend').remove();
	svg.selectAll('#result').remove();
	projection = d3.geo.azimuthal()
		.mode('equidistant')
		.scale(680)
		.origin([113.03, 30.37])
		.translate([400, 300]);

	path = d3.geo.path()
		.projection(projection);

	var data = [{
			id : 1,
			text : '航運塗料'
		}, {
			id : 2,
			text : '公路投資'
		}, {
			id : 3,
			text : '船舶備件',
			target : 'test'
		}, {
			id : 4,
			text : '工業製造',
			target : 'project'
		}, {
			id : 5,
			text : 'IT諮詢'
		}, {
			id : 6,
			text : '船舶燃油貿易'
		}, {
			id : 7,
			text : '旅遊服務'
		}, {
			id : 8,
			text : '物業管理'
		}
	]

	
	
	
	//选择框
	var legend = svg.append("g").attr('id', 'legend').selectAll(".legend")
		.data(data)
		.enter().append("g")
		.attr("class", "legend")
		.attr("transform", function (d, i) {
			return "translate(0," + i * 67 + ")";
		}).style('font-size', '20px')

		legend.append('rect').attr("x", width - 160).attr('width', 140).attr('height', 30).attr('opacity', 0).attr('transform', 'translate(-180,0)').transition()
			.duration(750).attr('opacity', 1).attr('transform', 'translate(0,0)').style("fill", "url(#ButtonGradient)")

		legend.append("text").style('fill', 'black')
		.attr("x", width - 24)
		.attr("y", 9)
		.attr("dy", ".55em")
		.style("text-anchor", "end")
		.text(function (d) {
			return d.text;
		}).attr('target', function (d) {
			return d.target
		}).attr('class', 'high').attr('opacity', 0).attr('transform', 'translate(-180,0)').transition()
			.duration(750).attr('opacity', 1).attr('transform', 'translate(0,0)')

					d3.json("0.json", function (collection) {
			feature = g.append("g")
				.attr("id", "chinaMap").selectAll("path")
				.data(collection.features)
				.enter().append("path")
				.attr("d", path).attr('opacity', 0).transition()
			.duration(850).attr('opacity', 1);

			feature.append("title")
			.text(function (d) {
				return d.properties.name;
			});
		});
			
			
	var infoBox = svg.append("g").attr('width', 100)
		.attr("id", "result");
		
		


		
infoBox.append('rect').attr('id','resultBox').attr('width',160).attr('height',200).attr('x',width - 404).attr('y',height-290).attr('opacity', 0).attr('transform', 'translate(-180,0)').transition()
			.duration(750).attr('opacity', 1).attr('transform', 'translate(0,0)')

infoBox.append('rect').attr('id','resultBox').attr('width',160).attr('height',30).attr('x',width - 404).attr('y',height-330).attr('opacity', 0).attr('transform', 'translate(-180,0)').transition()
			.duration(750).attr('opacity', 1).attr('transform', 'translate(0,0)')			
			
	info = infoBox.append("text").attr("x", width - 394)
		.attr("y", height-250)
		.attr("dy", ".35em")
	titleBox = infoBox.append("text").attr("x", width - 350)
		.attr("y", height-315)
		.attr("dy", ".35em")

}

//中国地图部分

//点击后缩放
function clicked(d) {

	console.log(JSON.stringify(d))
	var x,
	y,
	k;

		var centroid = path.centroid(d);
		x = centroid[0];
		y = centroid[1];
		k = 1.5;
		centered = d;

	g.transition()
	.duration(750)
	.attr("transform", "translate(" + width / 2 + "," + height / 2 + ")scale(" + k + ")translate(" + -x + "," + -y + ")")
	.style("stroke-width", 1.5 / k + "px");
}

function transformTo(position) {

	// Transition to the new transform.
	g.transition()
	.duration(750)
	.attr("transform", "translate(" + position.x + "," + position.y + ")");
}
//transformTo({x:121,y:30})

var highLighted = {
	project : [{
			id : 32,
			info : '南通中遠重工有限公司 ------------------------ 地址：江蘇省海門市海 門港長春路2號'
		}, {
			id : 44,
			info : '新世紀標志（深圳） 有限公司 ------------------------ 地址：寶安區西鄉黃田 楊背工業區三期恒昌榮高 新科技園十棟壹、二樓'
		}, {
			id : 31,
			info : '中遠（江門）鋁業 有限公司 ------------------------  地址：上海市浦東新區 施新路990號'
		}, {
			id : 37,
			info : '中遠佐敦船舶塗料 （青島）有限公司 ------------------------ 地址：山東省青島市 香港中路10號 頤和國際A座2810室'
		}, {
			id : 81,
			info : '合興船務工程香港 有限公司 ------------------------  地址：香港興華街西81號 '
		}
	],
	test : [{
			id : 33,
			info : '南通中遠重工有限公司 ------------------------ 地址：江蘇省海門市海 門港長春路2號'
		}, {
			id : 34,
			info : '新世紀標志（深圳） 有限公司 ------------------------ 地址：寶安區西鄉黃田 楊背工業區三期恒昌榮高 新科技園十棟壹、二樓'
		}, {
			id : 35,
			info : '中遠（江門）鋁業 有限公司 ------------------------  地址：上海市浦東新區 施新路990號'
		}, {
			id : 36,
			info : '中遠佐敦船舶塗料 （青島）有限公司 ------------------------ 地址：山東省青島市 香港中路10號 頤和國際A座2810室'
		}, {
			id : 38,
			info : '合興船務工程香港 有限公司 ------------------------  地址：香港興華街西81號 '
		}
	]
}

function highlight(target,text) {

	g.selectAll("path")
	.classed("active", function (d) {
		var vs = highLighted[target];
		var l = vs.length,
		i = 0;
		for (; i < l; i++) {
			if (d.id == vs[i]['id'])
				return d;
		}
	}).attr('info', function (d) {

		var vs = highLighted[target];
		var l = vs.length,
		i = 0;
		for (; i < l; i++) {
			console.log(d.id, vs[i]['id'])
			if (d.id == vs[i]['id'])
				return vs[i]['info']
		}

	}).on('mouseover', function (d) {
		if ($(this).attr('info')) {
			info.text($(this).attr('info'))
			titleBox.text(text)
			insertLinebreaks(info)
			clicked(d)
		}

	})
}

function insertLinebreaks(d) {
	var words = d.text().split(' ');
	d.text('');

	for (var i = 0; i < words.length; i++) {
		var tspan = d.append('tspan').text(words[i]);
		if (i > 0)
			tspan.attr('x', width - 394).attr('dy', '15');
	}
};

function removeAll() {

	g.selectAll("path")
	.classed("");
}

$(document).delegate('.high', 'click', function () {
	var p = $(this).attr('target');
	removeAll();
	highlight(p,$(this).text())
	g.transition().duration(400).attr("transform", "scale(1)");
})

	  
	  
	  
    </script>
  </body>
</html>
